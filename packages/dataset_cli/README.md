# Davis CLI：データセット管理ツール<!-- omit in toc -->

`davis-cli` は、行動モデル夏の学校で利用するデータセットを簡単に取得・管理するためのコマンドラインツールです。

> [!WARNING]
> 現在は行動モデル夏の学校の参加者のみが利用できます。

## 1. 主な機能

- 利用可能なデータセットの一覧表示
- データセットの詳細情報の確認
- 指定したデータセットのダウンロード

## 2. インストール

### 2.1. 前提条件

Gitがインストールされている必要があります。
お使いのOSに応じて、以下のリンクからインストールしてください。

- **Windows**: [Git公式サイト](https://git-scm.com/download/win)
- **macOS**: [Git公式サイト](https://git-scm.com/download/mac)
- **Linux**: 各ディストリビューションのパッケージマネージャを使用してインストールしてください（例: `sudo apt install git`）。

また、環境によっては[DVC (Data Version Control)](https://dvc.org/) も手動でインストールする必要があります。
以下の「インストール手順」、「初回セットアップ」の手順を完了した後に、`davis get` コマンドを実行した際にDVCが見つからない旨のエラーメッセージが表示された場合は、DVCをインストールしてください。

- **DVCのインストール**: [DVC公式サイト](https://dvc.org/doc/install) の手順に従ってインストールしてください。
    - `uv tool install dvc[gdrive]` でインストールすることができます。

### 2.2. インストール手順

現在、`davis-cli` は `uv` または `pip` を使ってGitリポジトリから直接インストールする必要があります。
（PyPIでの公開は予定していません。）
特別な理由がなければ、`uv` を使うことを強く推奨します。

```bash
# uvを使う場合（強く推奨。特別な理由がなければこちらを使用してください）
uv tool install git+https://github.com/bin-utokyo/davis#subdirectory=packages/dataset_cli

# pipを使う場合
pip install git+https://github.com/bin-utokyo/davis.git#subdirectory=packages/dataset_cli
```

インストール後、PATHが通っていることを確認してください。
`davis --help` コマンドが実行できれば成功です。

uvを使ってインストールした場合は、PATHの通し方が表示されることがありますので、その指示に従ってください。

## 3. 初回セットアップ

インストール後、最初に `setup` コマンドを実行して、データダウンロードに必要な認証情報を設定します。

```bash
davis setup
```

このコマンドを実行すると、以下の3つの情報を入力するよう求められます。

1. **Google Drive フォルダID**
2. **Google Cloud Client ID**
3. **Google Cloud Client Secret**

これらの情報は、データが保管されているGoogle Driveにアクセスするために必要です。以下に取得方法を詳しく説明します。

### 3.1. 認証情報の取得方法

> [!NOTE]
> この操作によって請求が発生することはありません。
> また、運営側が利用者のGoogleアカウント情報にアクセスすることもできません。
> なお、運営側はこの操作によって生じた問題について責任を負いかねますので、あらかじめご了承ください。

#### 3.1.1. Google Cloudプロジェクトの作成

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセスし、Googleアカウントでログインします。
2. 画面上部のプロジェクト選択メニューから「新しいプロジェクト」をクリックし、任意のプロジェクト名（例: `davis-data-access`）で新しいプロジェクトを作成します。

#### 3.1.2. Google Drive APIの有効化

1. 作成したプロジェクトが選択されていることを確認し、左側のナビゲーションメニューから「APIとサービス」 > 「ライブラリ」を選択します。
2. 検索バーに「**Google Drive API**」と入力し、表示されたAPIをクリックします。
3. 「有効にする」ボタンをクリックして、APIを有効化します。

#### 3.1.3. OAuth 2.0 クライアントIDの発行

1. 左側のナビゲーションメニューから「APIとサービス」 > 「認証情報」を選択します。
2. 画面上部の「認証情報を作成」をクリックし、「OAuth クライアント ID」を選択します。
3. 「同意画面を構成」を求められた場合は、以下の手順で設定します。メールアドレスが外部に公開されることはありません。
    - **アプリ名**: `davis-cli` など、わかりやすい名前を入力します。
    - **ユーザーサポートメール**: ご自身のメールアドレスを選択します。
    - **対象**: 「外部」を選択します。
    - **連絡先情報**: ご自身のメールアドレスを入力します。
    - ポリシーに同意し、「次へ」をクリックし、「作成」をクリックします。
4. 再度「認証情報」の画面に戻り、「認証情報を作成」 > 「OAuth クライアント ID」を選択します。
5. 「アプリケーションの種類」で「**デスクトップアプリ**」を選択します。
6. 名前に「davis-cli-local」などと入力し、「作成」をクリックします。
7. 作成が完了すると、「**クライアントID**」と「**クライアントシークレット**」が表示されます。これらをコピーして、`davis setup`コマンドのプロンプトに貼り付けてください。

すべての情報を入力すると、設定がホームディレクトリの `.config/davis/config.ini` に保存され、ツールの準備が完了します。

#### 3.1.4. テストユーザーの追加

1. 左側のナビゲーションメニューから「APIとサービス」 > 「OAuth同意画面」を選択します。
2. 左側の「対象」をクリックし、「テストユーザー」セクションまでスクロールします。
3. 「Add users」をクリックし、ご自身のGoogleアカウントのメールアドレスを追加します。

## 4. データセットの利用方法

### 4.1. 利用可能なデータセットの一覧表示

`list` コマンドで、ダウンロード可能なデータセットの一覧を確認できます。

```bash
davis list
```

### 4.2. データセットの詳細情報を確認

`info` コマンドで、特定のデータセットに含まれるファイルやドキュメントの情報を確認できます。

```bash
davis info <DATASET_ID>
```

- `<DATASET_ID>` には、`list`コマンドで表示されたIDを指定します。
- `--open` オプションを付けると、関連ドキュメント（PDF）をブラウザで開きます。このドキュメントには、カラムの型など、データセットの詳細な説明が含まれています。

```bash
# 例: PT_dataデータセットの情報を表示し、PDFをブラウザで開く
davis info PT_data --open
```

### 4.3. データセットのダウンロード

`get` コマンドで、データセットを手元にダウンロードします。

ファイル単位でダウンロードすることもできますし、ディレクトリ単位でまとめてダウンロードすることも可能です。

```bash
davis get <DATASET_ID>
```

- ダウンロード先のディレクトリを指定する場合は `--out` または `-o` オプションを使用します。

```bash
# 例: PT_dataデータセットを 'my_data' ディレクトリにダウンロードする
davis get PT_data -o my_data/
```

> [!NOTE]
> 初回実行時には、Googleアカウントの認証が必要です。ブラウザが自動的に起動し、認証を求められます。
> 「このアプリはGoogleで確認されていません」という警告が表示される場合がありますが、これは正常です。画面下部の「続行」リンクをクリックし、「davis-cli（安全ではないページ）に移動」を選択して続行してください。

## 5. その他

### 5.1. ヘルプの表示

各コマンドの詳細な使い方は、`--help` オプションで確認できます。

```bash
davis --help
davis list --help
davis info --help
davis get --help
```

この他のコマンドについても、同様に `--help` オプションで詳細を確認できます。

なお、`davis setup` コマンドは一度実行すれば再度実行する必要はありません。認証情報を更新したい場合にのみ再実行してください。

また、`davis manage` コマンドはデータセットの管理者向けの機能であり、一般ユーザーは使用する必要はありません。

## 6. サポート

問題や質問がある場合は、行動モデル夏の学校のSlackにて運営側にお問い合わせください。
